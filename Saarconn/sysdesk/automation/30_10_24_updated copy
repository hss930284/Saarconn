#importing required modules

import importlib
import os
import Utilities
from pathlib import Path
import pandas as pd  # Import pandas
importlib.reload(Utilities) # reloading Utilities
SdApplication = Utilities.ConnectToSystemDesk() # Connect to SystemDesk (get COM object)
import SystemDeskEnums  # type: ignore # pylint: disable=wrong-import-position
importlib.reload(SystemDeskEnums)
import re

def ReadUserDefinedExcel():
    # Load the user defined Excel file
    global Input_Excel_File
    Input_Excel_File = input("Please select the input Excel file (e.g., E:\\sysdesk\\automation): ")
    # referring xls variable as entire excel
    global xls
    xls = pd.ExcelFile(Input_Excel_File)
    # Read the first sheet
    global first_sheet
    first_sheet = pd.read_excel(Input_Excel_File, sheet_name=0,header=None)
    global sd_project
    sd_project = first_sheet.iloc[4,3] # Get the project name from cell D5

def GetColumnValidIndex(CellNo, NextTableCellValue):
    ActualValidCellNo = None
    def string_to_number(s):
        num = 0
        length = len(s)
        s = s.lower()
        
        for i, char in enumerate(s):
            value = ord(char) - ord('a')
            num += value * (26 ** (length - i - 1))
        
        return num

    match = re.match(r"([a-zA-Z]+)(\d+)", CellNo)
    if match:
        global CellNo_Colomn,CellNo_Row
        CellNo_Colomn = match.group(1)  # Alphabetical part
        CellNo_Row = match.group(2)  # Numerical part
    else:
        print("The input does not match the expected format.")

    Actual_CellNo_Colomn = string_to_number(CellNo_Colomn)
    Actual_CellNo_Row = int(CellNo_Row) - 1

    # Store values in a list to keep track
    values = []
    
    # Start searching from the specified row and column index
    for index in range(Actual_CellNo_Row, len(current_df)):
        cell_value = current_df.iloc[index, Actual_CellNo_Colomn]
        
        if pd.isna(cell_value):  # Check if the cell is empty (NaN)
            # Check if the next row exists
            if index + 1 < len(current_df):
                next_cell_value = current_df.iloc[index + 1, Actual_CellNo_Colomn]
                if next_cell_value == NextTableCellValue:
                    break  # Stop processing when the next cell matches "Interface Type"
            continue  # Continue to the next iteration if the current cell is NaN
        else:
            values.append(cell_value)  # Collect valid cell values
    
            
    # Print or return the collected values if needed
    print("Collected values:", values)
    global storedvariable
    storedvariable = values
    print(f"storedvariable:{storedvariable}")
    ActualValidCellNo = len(values)  # or return values, or index as needed

    return ActualValidCellNo
    # return ActualValidCellNo

def ProjectConfig():
    """
    #####################################
    Configuring project
    #####################################
    """
    # Global configuration options (shared with Utilities).
    global Options
    Options = Utilities.Options

    # Name of this project.
    Options.ProjectName = sd_project   # < %%%--- Change this to your project name.%%%



    # Set True to open an existing SystemDesk project (SDP). Otherwise, the SystemDesk project is created from scratch.
    Options.OpenExistingProject = False

    # Name of the AUTOSAR system.
    Options.SystemName = "System"


    # Set True to create a separate ECUs for the front-left- and front-right-indicators.
    Options.UseFrontIndicatorEcus = True


    # Set True to create SWC implementations with this script. Otherwise they can be imported from TargetLink.
    Options.CreateImplementations = True


    # Set True to import the network communication (Fibex) elements from a AUTOSAR System Description file.
    Options.ImportNetworkCommunicationElements = True


    # Set True to generate code for all ECU BSW modules including RTE.
    Options.GenerateCode = True


    # Set True if the SYD_MOD license for SystemDesk is available.
    Options.License_SYD_MOD = True


    # Set True to build an Offline Simulation Application for VEOS.
    Options.BuildForVeos = True


    # Set True to save the SystemDesk project when this script at the end of lesson 14.
    Options.SaveProject = True

def CreateProjectAndPackages():#need to revisit  this function and compare with utility function

    """
    Creates a new package for software components and compositions.
    """
    Utilities.CreateProject()
    SdProject = SdApplication.ActiveProject
    applRootDir = r"<InstallationDir>"

    # List of template files to be imported.
    templateFiles = [os.path.join(applRootDir, r"Templates\FolderStructure.arxml")]

    # Now import the files.
    Utilities.ImportAutosarFilesAtProject(templateFiles)

    # Package "Communication" is not needed if the whole IndicatorSystem is
    # implemented on only one ECU.
    # if not Options.UseFrontIndicatorEcus:
    #     communicationPackage = SdProject.RootAutosar.ArPackages.Item("Communication")
    #     if communicationPackage != None:
    #         communicationPackage.Delete()
    # return "Function CreateProjectAndPackages executed"

    print("Function CreateProjectAndPackages executed")

def CleanupProjectAndPackages(): #not necessary at this moment, will include this  in the next version

    """
    Removes unnecessary elements which have been imported from the template files.
    """

    # Get existing project elements.
    rootPackage = SdApplication.ActiveProject.RootAutosar
    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    # Delete packages MySwc and MyComposition, which were imported from
    # template "PackageStructure.arxml".
    mySwc = swComponentTypesPackage.ArPackages.Item("MySwc")
    if mySwc != None:
        mySwc.Delete()
    myComposition = swComponentTypesPackage.ArPackages.Item("MyComposition")
    if myComposition != None:
        myComposition.Delete()

    # return "Function CleanupProjectAndPackages executed"

def CreateSwcs():
    global rootPackage,current_df,value_d3,sheet_name
    rootPackage = SdApplication.ActiveProject.RootAutosar
    for sheet_name in xls.sheet_names[1:]:  # This will skip the first sheet #move this excel part to perticular section of this code
        current_df = pd.read_excel(xls, sheet_name=sheet_name,header=None)
        # Get the value from cell D3 (row index 2, column index 3)
        # value_d3 = current_df.iloc[2,3]  # D3 corresponds to row 2, column 3

        a=GetColumnValidIndex("d3", "Port Type")

        value_d3=current_df.iloc[a,3]

        print(value_d3)

        if value_d3 == 'ApplicationSwComponentType':
            ApplicationSwComponentType()
        elif value_d3 == 'ComplexDeviceDriverSwComponentType':
            ComplexDeviceDriverSwComponentType()
        elif value_d3 == 'EcuAbstractionSwComponentType':
            EcuAbstractionSwComponentType()
        elif value_d3 == 'NvBlockSwComponentType':
            NvBlockSwComponentType()
        elif value_d3 == 'ParameterSwComponentType':
            ParameterSwComponentType()
        elif value_d3 == 'SensorActuatorSwComponentType':
            SensorActuatorSwComponentType()
        elif value_d3 == 'ServiceProxySwComponentType':
            ServiceProxySwComponentType()
        elif value_d3 == 'ServiceSwComponentType':
            ServiceSwComponentType()
        else:
            print(f"In sheet '{sheet_name}', Please provide correct software component type")

#########################################################################################################################################
             ###########-------------------------------ApplicationSwComponentType-------------------------------############
#########################################################################################################################################
def ApplicationSwComponentType():
    global CurrentswComponentTypesPackage, CurrentApplSWCPkg, CurrentSWC, CurrentInternalBehaviors, CurrentRunnable, CurrentEvent

    CurrentswComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    CurrentApplSWCPkg= CurrentswComponentTypesPackage.ArPackages.Item("ApplSWC") # use this method >>ilSwcType = Utilities.GetElementByPath("/SwComponentTypes/IndicatorLogic/IndicatorLogic")
   
    CurrentSWC = CurrentApplSWCPkg.Elements.AddNewApplicationSwComponentType(current_df.iloc[2,2])

    CurrentInternalBehaviors = CurrentSWC.InternalBehaviors.AddNew(current_df.iloc[2,4])

    GetColumnValidIndex("f3", "Interface Type")
    for runnable_name in storedvariable:  # Assuming 'values' contains the names for the runnables
        CurrentRunnable = CurrentInternalBehaviors.Runnables.AddNew(runnable_name)
        CurrentRunnable.MinimumStartInterval = 0.0
        CurrentRunnable.CanBeInvokedConcurrently = False
        CurrentRunnable.Symbol = CurrentRunnable.ShortName
        # Utilities.SetDescription(tssPreRun, "Performs preprocessing of TurnSwitchSensor signals.")

    # createrteevent()
    # GetColumnValidIndex("G3", "DataElement")
    # for event_name in storedvariable:  # Assuming 'values' contains the names for the runnables
    #     CurrentEvent = CurrentInternalBehaviors.Events.AddNewTimingEvent(event_name)
    #     # Utilities.SetDescription(tssEvent, "TimingEvent for TssPreprocessing Runnable [10 ms period].")
    #     CurrentEvent.Period = 0.01
    #     CurrentEvent.StartOnEventRef = CurrentRunnable

# createrteevent() same as createswc() get enum list from the picture

def InitEvent(CurrentRteEvent):
    CurrentEvent = CurrentInternalBehaviors.Events.AddNewInitEvent(current_df.iloc[CurrentRteEvent,CellNo_Colomn-1])
    # Utilities.SetDescription(tssEvent, "TimingEvent for TssPreprocessing Runnable [10 ms period].")
    CurrentEvent.StartOnEventRef = CurrentRunnable

def TimingEvent(CurrentRteEvent):
    CurrentEvent = CurrentInternalBehaviors.Events.AddNewTimingEvent(current_df.iloc[CurrentRteEvent,CellNo_Colomn-1])
    # Utilities.SetDescription(tssEvent, "TimingEvent for TssPreprocessing Runnable [10 ms period].")
    CurrentEvent.Period = 0.01
    CurrentEvent.StartOnEventRef = CurrentRunnable

def AsynchronousServerCallReturnsEvent(CurrentRteEvent):
    CurrentEvent = CurrentInternalBehaviors.Events.AddNewInitEvent(current_df.iloc[CurrentRteEvent,CellNo_Colomn-1])
    # Utilities.SetDescription(tssEvent, "TimingEvent for TssPreprocessing Runnable [10 ms period].")
    CurrentEvent.StartOnEventRef = CurrentRunnable


def BackgroundEvent(CurrentRteEvent):
    CurrentEvent = CurrentInternalBehaviors.Events.AddNewInitEvent(current_df.iloc[CurrentRteEvent,CellNo_Colomn-1])
    # Utilities.SetDescription(tssEvent, "TimingEvent for TssPreprocessing Runnable [10 ms period].")
    CurrentEvent.StartOnEventRef = CurrentRunnable



# def createrteevent():

#        lastCellRowNo= GetColumnValidIndex("H3", "Application Data Type")

#        a=int(CellNo_Row)

#        for CurrentRowNo in range(a, lastCellRowNo):
#             print(f"Processing row: {CurrentRowNo}")
#             event_type = current_df.iloc[CurrentRowNo, CellNo_Colomn]
            
#             if event_type == 'AsynchronousServerCallReturnsEvent':
#                 AsynchronousServerCallReturnsEvent(CurrentRowNo)
#             elif event_type == 'InitEvent':
#                 InitEvent(CurrentRowNo)
#             elif event_type == 'TimingEvent':
#                 TimingEvent(CurrentRowNo)
#             else:
#                 print(f"In sheet '{sheet_name}', please provide correct software component type: {event_type}")








#     #    for  CurrentRowNo in range(a, lastCellRowNo):
           
           
           
            


#             # print(CurrentRowNo)
#             # if (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'AsynchronousServerCallReturnsEvent':
#             #     AsynchronousServerCallReturnsEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'BackgroundEvent':
#             # #     BackgroundEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'DataReceivedEvent':
#             # #     DataReceivedEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'DataReceiveErrorEvent':
#             # #     DataReceiveErrorEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'DataSendCompletedEvent':
#             # #     DataSendCompletedEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'DataWriteCompletedEvent':
#             # #     DataWriteCompletedEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'ExternalTriggerOccurredEvent':
#             # #     ExternalTriggerOccurredEvent(CurrentRowNo)
#             # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'InitEvent':
#             #     InitEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'InternalTriggerOccurredEvent':
#             # #     InternalTriggerOccurredEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'ModeSwitchedAckEvent':
#             # #     ModeSwitchedAckEvent(CurrentRowNo)
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'OperationInvokedEvent':
#             # #     OperationInvokedEvent(CurrentRowNo) 
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'SwcModeManagerErrorEvent':
#             # #     SwcModeManagerErrorEvent(CurrentRowNo) 
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'SwcModeSwitchEvent':
#             # #     SwcModeSwitchEvent(CurrentRowNo)
#             # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'TimingEvent':
#             #     TimingEvent(CurrentRowNo) 
#             # # elif (current_df.iloc[CurrentRowNo,CellNo_Colomn]) == 'TransformerHardErrorEvent':
#             # #     TransformerHardErrorEvent(CurrentRowNo)                            
#             # else:
#             #     print(f"In sheet '{sheet_name}',Please provide correct software component type")

    
    

#########################################################################################################################################
             ###########-------------------------------ComplexDeviceDriverSwComponentType-------------------------------############
#########################################################################################################################################   
def ComplexDeviceDriverSwComponentType():
    global swComponentTypesPackage, CddSWC, CurrentSWC

    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    CddSWC= swComponentTypesPackage.ArPackages.Item("CddSWC")
   
    CurrentSWC = CddSWC.Elements.AddNewComplexDeviceDriverSwComponentType(current_df.iloc[2,2])

#########################################################################################################################################
             ###########-------------------------------EcuAbstractionSwComponentType-------------------------------############
#########################################################################################################################################
def EcuAbstractionSwComponentType():
    global swComponentTypesPackage, EcuAbSWC, CurrentSWC

    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    EcuAbSWC= swComponentTypesPackage.ArPackages.Item("EcuAbSWC")
   
    CurrentSWC = EcuAbSWC.Elements.AddNewEcuAbstractionSwComponentType(current_df.iloc[2,2])

#########################################################################################################################################
             ###########-------------------------------NvBlockSwComponentType-------------------------------############
#########################################################################################################################################
def NvBlockSwComponentType():
    global swComponentTypesPackage, NvDataSWC, CurrentSWC

    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    NvDataSWC= swComponentTypesPackage.ArPackages.Item("NvDataSWC")
   
    CurrentSWC = NvDataSWC.Elements.AddNewNvBlockSwComponentType(current_df.iloc[2,2])

#########################################################################################################################################
             ###########-------------------------------ParameterSwComponentType-------------------------------############
#########################################################################################################################################
def ParameterSwComponentType():
    global swComponentTypesPackage, PrmSWC, CurrentSWC

    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    PrmSWC= swComponentTypesPackage.ArPackages.Item("PrmSWC")
   
    CurrentSWC = PrmSWC.Elements.AddNewParameterSwComponentType(current_df.iloc[2,2])

#########################################################################################################################################
             ###########-------------------------------SensorActuatorSwComponentType-------------------------------############
#########################################################################################################################################
def SensorActuatorSwComponentType():
    global swComponentTypesPackage, SnsrActSWC, CurrentSWC

    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    SnsrActSWC= swComponentTypesPackage.ArPackages.Item("SnsrActSWC")
   
    CurrentSWC = SnsrActSWC.Elements.AddNewSensorActuatorSwComponentType(current_df.iloc[2,2])

#########################################################################################################################################
             ###########-------------------------------ServiceProxySwComponentType-------------------------------############
#########################################################################################################################################
def ServiceProxySwComponentType():
    global swComponentTypesPackage, SrvcPrxySWC, CurrentSWC

    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    SrvcPrxySWC= swComponentTypesPackage.ArPackages.Item("SrvcPrxySWC")
   
    CurrentSWC = SrvcPrxySWC.Elements.AddNewServiceProxySwComponentType(current_df.iloc[2,2])

#########################################################################################################################################
             ###########--------------------------------------ServiceSwComponentType---------------------------------------############
#########################################################################################################################################
def ServiceSwComponentType():
    global swComponentTypesPackage, SrvcSWC, CurrentSWC

    swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")

    SrvcSWC= swComponentTypesPackage.ArPackages.Item("SrvcSWC")
   
    CurrentSWC = SrvcSWC.Elements.AddNewServiceSwComponentType(current_df.iloc[2,2])








    # swComponentTypesPackage = rootPackage.ArPackages.Item("SwComponentTypes")
    # mySwc = swComponentTypesPackage.ArPackages.Item("MySwc")
    # myApplicationSw = mySwc.ArComponents.Item("MyApplicationSw")
    # myApplicationSw.Delete()
    # myApplicationSw = mySwc.ArComponents.Item("MyApplicationSw")
    # myApplicationSw.Create()
    # myApplicationSw.Name = "MyApplicationSw"
    # myApplicationSw.Description = "MyApplicationSw Description"
    # myApplicationSw.Category = "Application"
    # myApplicationSw.Type = "ApplicationSwComponentType"
    # myApplicationSw.SwComponentType = "ApplicationSwComponentType"
    



def ProjectSave():
    # SdApplication.ActiveProject.Save() #try this function later
    # SdApplication.ActiveProject.SaveAs(r"<SavePath>")
    # print("Function ProjectSave executed")
    
    # # Save the SystemDesk project.
    if Options.SaveProject: 
        # Constructing the project file name
        project_file_name = f"{Options.ProjectName}.sdp"  
        
        
        user_defined_path = input("Please give the path where you want to save the project (e.g., E:\\sysdesk\\automation): ")
        
        # Check if the provided path exists
        if not os.path.exists(user_defined_path):
            print("Invalid path....!!!!")
            user_defined_path = input("Please give the appropraite path where you want to save the project (e.g., E:\\sysdesk\\automation): ")
            return  
        
        # full project file path
        project_file_path = os.path.join(user_defined_path, project_file_name)
        
        # Save the project to the specified path
        Utilities.SaveProject(project_file_path)  
        print(f"*** Saving project as '{project_file_name}' to '{project_file_path}'. ***") 
    else: 
        print("*** Project not saved. ***") 

def Main():
    ReadUserDefinedExcel()
    ProjectConfig()
    CreateProjectAndPackages()
    CleanupProjectAndPackages()
    CreateSwcs()
    ProjectSave()

#-------------
# Run the demo
#-------------
if (__name__ == "__main__"):
    Main()
    print("Ready")



